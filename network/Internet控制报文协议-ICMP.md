## ICMP

ICMP：主要用于传递差错报文。在IP通信中如果某个IP包因为某种原因未能达到目标地址，那么这个具体的原因将由ICMP负责通知。

![](assets/image-20200717113507383.png)



ICMP报文格式

![](assets/image-20200729142356630.png)

ICMP 报文分为差错报告报文和询问报文。

![](assets/image-20200729142436608.png)



## Ping

Ping 用来测试两台主机之间的连通性。通过向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 回答报文。然后根据时间和成功响应的次数估算出数据包往返时间以及丢包率。

![](assets/image-20200729143905105.png)



## Traceroute

Traceroute 用于跟踪一个分组从源点到终点的路径。源主机发送无法交付的 UDP 用户数据报，当目的主机收到报文后再发送终点不可达差错报告报文通知源主机。

- 源主机向目的主机发送一连串的 IP 数据报。第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文；
- 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文。
- 不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文。
- 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。